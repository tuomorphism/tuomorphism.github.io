---
import type { CollectionEntry } from 'astro:content';
import ProjectCard from './ProjectCard.astro';

interface Props {
  items: CollectionEntry<'projects'>[];
  previewCount?: number;
}
const { items, previewCount } = Astro.props as Props;

const sortedItems = [...items].sort((a, b) => {
  if (a.data.tier !== b.data.tier) return a.data.tier - b.data.tier;
  const bDate = (b.data.date || new Date()).getTime()
  const aDate = (a.data.date || new Date()).getTime()
  // Date comparison, newer first
  if (aDate != bDate) return bDate - aDate;
  return a.data.title.localeCompare(b.data.title);
});

const visibleItems = typeof previewCount === 'number'
  ? sortedItems.slice(0, previewCount)
  : sortedItems;

const tier1Items = visibleItems.filter((p) => p.data.tier === 1);
const otherItems = visibleItems.filter((p) => p.data.tier !== 1);
---

<section id="projects" class="space-y-6">
  <!-- Row of tier 1 (hero) projects -->
  {tier1Items.length > 0 && (
    <div
      class="grid gap-4 sm:gap-4 lg:gap-4
             grid-cols-1 sm:grid-cols-2 lg:grid-cols-3"
    >
      {tier1Items.map((p) => (
        <article class="grid-item">
          <div class="grid-item-content">
            <ProjectCard project={p} />
          </div>
        </article>
      ))}
    </div>
  )}

  <!-- Masonry grid for the rest -->
  {otherItems.length > 0 && (
    <div
      id="projects-masonry"
      class="masonry-grid grid gap-4 sm:gap-4 lg:gap-4
             grid-cols-1 sm:grid-cols-2 lg:grid-cols-3"
    >
      {otherItems.map((p) => (
        <article class="grid-item">
          <div class="grid-item-content">
            <ProjectCard project={p} />
          </div>
        </article>
      ))}
    </div>
  )}
</section>

<script is:inline>
  // Masonry for the "other" projects only
  const grid = document.querySelector('#projects-masonry');

  if (grid) {
    const gap = parseInt(getComputedStyle(grid).gap) || 0;
    const row = parseInt(
      getComputedStyle(grid).getPropertyValue('--masonry-row') || '8'
    ); // px

    const size = (item) => {
      const content = item.querySelector('.grid-item-content') || item;
      const h = content.getBoundingClientRect().height;
      const span = Math.ceil((h + gap) / (row + gap));
      item.style.gridRowEnd = `span ${span}`;
    };

    const all = () => grid.querySelectorAll('.grid-item').forEach(size);

    const ro = new ResizeObserver(() => all());
    grid.querySelectorAll('.grid-item-content').forEach((el) => ro.observe(el));

    window.addEventListener('load', all);
    window.addEventListener('resize', all);
    all();
  }
</script>

